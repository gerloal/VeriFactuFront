@page
@model Verifactu.Portal.Pages.Invoices.ExportModel
@{
    ViewData["Title"] = "Exportar facturas";
}

<h1 class="mb-4">Exportar facturas en XML</h1>
<p class="text-muted">Descarga todas las facturas del periodo indicado en un archivo comprimido con su representación XML.</p>

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<form method="post" class="row g-3 mb-4" id="invoice-export-form">
    <div class="col-sm-4 col-md-3">
        <label asp-for="FechaDesde" class="form-label"></label>
        <input asp-for="FechaDesde" type="date" class="form-control" />
        <span asp-validation-for="FechaDesde" class="text-danger"></span>
    </div>
    <div class="col-sm-4 col-md-3">
        <label asp-for="FechaHasta" class="form-label"></label>
        <input asp-for="FechaHasta" type="date" class="form-control" />
        <span asp-validation-for="FechaHasta" class="text-danger"></span>
    </div>
    <div class="col-12">
        <label class="form-label mb-2">Documentos incluidos</label>
        <div class="d-flex flex-wrap gap-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="PreFirma" id="docs-prefirma" name="Docs" checked />
                <label class="form-check-label" for="docs-prefirma">PreFirma</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="PostFirma" id="docs-postfirma" name="Docs" checked />
                <label class="form-check-label" for="docs-postfirma">PostFirma</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Aeat" id="docs-aeat" name="Docs" />
                <label class="form-check-label" for="docs-aeat">Aeat</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Qr" id="docs-qr" name="Docs" />
                <label class="form-check-label" for="docs-qr">Qr</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="all" id="docs-all" />
                <label class="form-check-label" for="docs-all">Todos</label>
            </div>
        </div>
        <div class="form-text">Por defecto: PreFirma + PostFirma.</div>
    </div>
    <div class="col-12">
        <div id="export-status" class="alert alert-info d-none" role="status">
            Generando la exportación, la descarga comenzará en unos instantes.
        </div>
        <button type="submit" class="btn btn-primary" id="export-submit">
            <span id="export-spinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span id="export-button-text">Generar exportación</span>
        </button>
        <button type="button" class="btn btn-success d-none" id="export-download">Descargar</button>
        <button type="button" class="btn btn-outline-danger d-none" id="export-delete">Eliminar exportación</button>
        <a asp-page="./Index" class="btn btn-outline-secondary">Volver</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const form = document.getElementById('invoice-export-form');
            const submitButton = document.getElementById('export-submit');
            const spinner = document.getElementById('export-spinner');
            const buttonText = document.getElementById('export-button-text');
            const statusAlert = document.getElementById('export-status');
            const downloadButton = document.getElementById('export-download');
            const deleteButton = document.getElementById('export-delete');
            const defaultButtonText = buttonText ? buttonText.textContent : 'Generar exportación';
            const processingMessage = 'Exportación en curso. Esto puede tardar unos segundos…';
            const pollingIntervalMs = 3000;

            let currentJobId = null;
            let currentDownloadUrl = null;
            let pollTimerId = null;

            if (!form || !submitButton || !spinner || !buttonText || !statusAlert || !downloadButton || !deleteButton) {
                return;
            }

            const stopPolling = () => {
                if (pollTimerId) {
                    window.clearInterval(pollTimerId);
                    pollTimerId = null;
                }
            };

            const resetActions = () => {
                currentDownloadUrl = null;
                downloadButton.classList.add('d-none');
                deleteButton.classList.add('d-none');
            };

            const resetStatus = () => {
                statusAlert.textContent = '';
                statusAlert.classList.add('d-none');
                statusAlert.classList.remove('alert-danger', 'alert-success', 'alert-warning');
                if (!statusAlert.classList.contains('alert-info')) {
                    statusAlert.classList.add('alert-info');
                }
            };

            const showStatus = (message, type) => {
                if (!message) {
                    resetStatus();
                    return;
                }

                statusAlert.textContent = message;
                statusAlert.classList.remove('d-none', 'alert-info', 'alert-danger', 'alert-success', 'alert-warning');
                statusAlert.classList.add(`alert-${type}`);
            };

            const setLoadingState = () => {
                submitButton.disabled = true;
                spinner.classList.remove('d-none');
                buttonText.textContent = 'Creando exportación...';
                showStatus(processingMessage, 'info');
            };

            const restoreButton = () => {
                submitButton.disabled = false;
                spinner.classList.add('d-none');
                buttonText.textContent = defaultButtonText;
            };

            const downloadFromUrl = async () => {
                if (!currentJobId) {
                    showStatus('No hay ninguna exportación activa.', 'warning');
                    return;
                }

                if (!currentDownloadUrl) {
                    await pollStatusOnce();
                }

                if (!currentDownloadUrl) {
                    showStatus('La exportación aún no está lista para descargar.', 'warning');
                    return;
                }

                window.location.assign(currentDownloadUrl);
                showStatus('Descarga iniciada. Si caduca el enlace, vuelve a consultar el estado.', 'success');
            };

            const deleteCurrentJob = async () => {
                if (!currentJobId) {
                    resetActions();
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.set('jobId', currentJobId);
                    const response = await fetch('?handler=Delete', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        showStatus('No se pudo eliminar la exportación.', 'danger');
                        return;
                    }

                    stopPolling();
                    currentJobId = null;
                    resetActions();
                    showStatus('Exportación eliminada.', 'success');
                } catch (error) {
                    console.error('Error eliminando la exportación.', error);
                    showStatus('No se pudo eliminar la exportación.', 'danger');
                }
            };

            const buildDocsParam = (formData) => {
                const allCheckbox = document.getElementById('docs-all');
                if (allCheckbox && allCheckbox.checked) {
                    return 'all';
                }

                const docs = formData.getAll('Docs')
                    .map(v => (v ?? '').toString().trim())
                    .filter(v => v.length > 0);

                if (docs.length === 0) {
                    return '';
                }

                return docs.join('|');
            };

            const docsAllCheckbox = document.getElementById('docs-all');
            const docsOptionCheckboxes = Array.from(document.querySelectorAll('input[name="Docs"]'));
            if (docsAllCheckbox && docsOptionCheckboxes.length > 0) {
                docsAllCheckbox.addEventListener('change', function () {
                    if (docsAllCheckbox.checked) {
                        docsOptionCheckboxes.forEach(cb => cb.checked = true);
                    }
                });

                docsOptionCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function () {
                        if (!cb.checked) {
                            docsAllCheckbox.checked = false;
                        }
                    });
                });
            }

            resetStatus();
            resetActions();

            const pollStatusOnce = async () => {
                if (!currentJobId) {
                    return;
                }

                const statusUrl = `?handler=Status&jobId=${encodeURIComponent(currentJobId)}`;
                const response = await fetch(statusUrl, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error('Status request failed');
                }

                const data = await response.json();
                const status = (data.status || '').toString().toUpperCase();
                const message = (data.message || '').toString().trim();
                const skipped = typeof data.skippedInvoices === 'number' ? data.skippedInvoices : null;

                if (status === 'PENDING' || status === 'RUNNING') {
                    showStatus(message || 'Exportación en curso…', 'info');
                    return;
                }

                if (status === 'COMPLETED') {
                    stopPolling();
                    currentDownloadUrl = data.downloadUrl || null;

                    let completedMessage = 'Exportación completada.';
                    if (skipped && skipped > 0) {
                        completedMessage += ` (${skipped} facturas omitidas)`;
                    }

                    showStatus(completedMessage, 'success');
                    downloadButton.classList.remove('d-none');
                    deleteButton.classList.remove('d-none');
                    restoreButton();
                    return;
                }

                if (status === 'FAILED') {
                    stopPolling();
                    showStatus(message || 'La exportación ha fallado. Prueba a reducir el rango.', 'danger');
                    restoreButton();
                    deleteButton.classList.remove('d-none');
                    return;
                }

                showStatus(message || 'Estado desconocido de la exportación.', 'warning');
            };

            const startPolling = () => {
                stopPolling();
                pollTimerId = window.setInterval(async () => {
                    try {
                        await pollStatusOnce();
                    } catch (error) {
                        console.error('Error consultando el estado de la exportación.', error);
                        showStatus('No se pudo consultar el estado de la exportación.', 'warning');
                    }
                }, pollingIntervalMs);
            };

            downloadButton.addEventListener('click', function () {
                downloadFromUrl();
            });

            deleteButton.addEventListener('click', function () {
                deleteCurrentJob();
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                resetStatus();
                setLoadingState();
                resetActions();
                stopPolling();

                try {
                    const formData = new FormData(form);
                    const docs = buildDocsParam(formData);
                    if (docs) {
                        formData.set('DocsCsv', docs);
                    }
                    const response = await fetch('?handler=Start', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        let message = 'No se pudo generar la exportación. Inténtalo de nuevo más tarde.';
                        const contentType = response.headers.get('Content-Type') ?? '';

                        try {
                            if (contentType.includes('application/json')) {
                                const data = await response.json();
                                if (data && typeof data.message === 'string') {
                                    const trimmed = data.message.trim();
                                    if (trimmed.length > 0) {
                                        message = trimmed;
                                    }
                                }
                            }
                            else {
                                const text = (await response.text()).trim();
                                if (text.length > 0 && text.length < 500) {
                                    message = text;
                                }
                            }
                        } catch (parseError) {
                            console.error('No se pudo interpretar la respuesta de error de la exportación.', parseError);
                        }

                        showStatus(message, 'danger');
                        return;
                    }

                    const data = await response.json();
                    currentJobId = data.jobId || null;
                    if (!currentJobId) {
                        showStatus('No se pudo crear el job de exportación.', 'danger');
                        restoreButton();
                        return;
                    }

                    showStatus('Exportación en curso…', 'info');
                    startPolling();
                } catch (error) {
                    console.error('Error inesperado al generar la exportación de facturas.', error);
                    showStatus('No se pudo generar la exportación. Inténtalo de nuevo más tarde.', 'danger');
                    restoreButton();
                }
            });
        })();
    </script>
}
