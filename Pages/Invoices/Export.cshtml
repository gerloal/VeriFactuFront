@page
@model Verifactu.Portal.Pages.Invoices.ExportModel
@{
    ViewData["Title"] = "Exportar facturas";
}

<h1 class="mb-4">Exportar facturas en XML</h1>
<p class="text-muted">Descarga todas las facturas del periodo indicado en un archivo comprimido con su representación XML.</p>

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<form method="post" class="row g-3 mb-4" id="invoice-export-form">
    <div class="col-sm-4 col-md-3">
        <label asp-for="FechaDesde" class="form-label"></label>
        <input asp-for="FechaDesde" type="date" class="form-control" />
        <span asp-validation-for="FechaDesde" class="text-danger"></span>
    </div>
    <div class="col-sm-4 col-md-3">
        <label asp-for="FechaHasta" class="form-label"></label>
        <input asp-for="FechaHasta" type="date" class="form-control" />
        <span asp-validation-for="FechaHasta" class="text-danger"></span>
    </div>
    <div class="col-12">
        <div id="export-status" class="alert alert-info d-none" role="status">
            Generando la exportación, la descarga comenzará en unos instantes.
        </div>
        <button type="submit" class="btn btn-primary" id="export-submit">
            <span id="export-spinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span id="export-button-text">Descargar exportación</span>
        </button>
        <a asp-page="./Index" class="btn btn-outline-secondary">Volver</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const form = document.getElementById('invoice-export-form');
            const submitButton = document.getElementById('export-submit');
            const spinner = document.getElementById('export-spinner');
            const buttonText = document.getElementById('export-button-text');
            const statusAlert = document.getElementById('export-status');
            const defaultButtonText = buttonText ? buttonText.textContent : 'Descargar exportación';
            const processingMessage = 'Generando la exportación, la descarga comenzará en unos instantes.';

            if (!form || !submitButton || !spinner || !buttonText || !statusAlert) {
                return;
            }

            const resetStatus = () => {
                statusAlert.textContent = '';
                statusAlert.classList.add('d-none');
                statusAlert.classList.remove('alert-danger', 'alert-success', 'alert-warning');
                if (!statusAlert.classList.contains('alert-info')) {
                    statusAlert.classList.add('alert-info');
                }
            };

            const showStatus = (message, type) => {
                if (!message) {
                    resetStatus();
                    return;
                }

                statusAlert.textContent = message;
                statusAlert.classList.remove('d-none', 'alert-info', 'alert-danger', 'alert-success', 'alert-warning');
                statusAlert.classList.add(`alert-${type}`);
            };

            const setLoadingState = () => {
                submitButton.disabled = true;
                spinner.classList.remove('d-none');
                buttonText.textContent = 'Preparando descarga...';
                showStatus(processingMessage, 'info');
            };

            const restoreButton = () => {
                submitButton.disabled = false;
                spinner.classList.add('d-none');
                buttonText.textContent = defaultButtonText;
            };

            const parseFileName = (disposition) => {
                if (!disposition) {
                    return null;
                }

                const fileNameStarMatch = /filename\*=UTF-8''([^;]+)/i.exec(disposition);
                if (fileNameStarMatch && fileNameStarMatch[1]) {
                    try {
                        return decodeURIComponent(fileNameStarMatch[1]);
                    } catch (error) {
                        return fileNameStarMatch[1];
                    }
                }

                const fileNameMatch = /filename="?([^";]+)"?/i.exec(disposition);
                if (fileNameMatch && fileNameMatch[1]) {
                    return fileNameMatch[1];
                }

                return null;
            };

            const triggerDownload = (blob, fileName) => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName || 'facturas-export.zip';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            };

            resetStatus();

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                resetStatus();
                setLoadingState();

                try {
                    const formData = new FormData(form);
                    const response = await fetch(form.action || window.location.href, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        let message = 'No se pudo generar la exportación. Inténtalo de nuevo más tarde.';
                        const contentType = response.headers.get('Content-Type') ?? '';

                        try {
                            if (contentType.includes('application/json')) {
                                const data = await response.json();
                                if (data && typeof data.message === 'string') {
                                    const trimmed = data.message.trim();
                                    if (trimmed.length > 0) {
                                        message = trimmed;
                                    }
                                }
                            }
                            else {
                                const text = (await response.text()).trim();
                                if (text.length > 0 && text.length < 500) {
                                    message = text;
                                }
                            }
                        } catch (parseError) {
                            console.error('No se pudo interpretar la respuesta de error de la exportación.', parseError);
                        }

                        showStatus(message, 'danger');
                        return;
                    }

                    const blob = await response.blob();
                    if (!blob || blob.size === 0) {
                        showStatus('No se recibieron datos para la exportación.', 'danger');
                        return;
                    }

                    let fileName = parseFileName(response.headers.get('Content-Disposition'));
                    if (!fileName) {
                        const fromValue = (formData.get('FechaDesde') ?? '').toString().split('T')[0] || 'desde';
                        const toValue = (formData.get('FechaHasta') ?? '').toString().split('T')[0] || 'hasta';
                        fileName = `facturas-${fromValue}-${toValue}.zip`;
                    }

                    triggerDownload(blob, fileName);
                    showStatus('La descarga se ha iniciado correctamente.', 'success');
                    window.setTimeout(resetStatus, 4000);
                } catch (error) {
                    console.error('Error inesperado al generar la exportación de facturas.', error);
                    showStatus('No se pudo generar la exportación. Inténtalo de nuevo más tarde.', 'danger');
                } finally {
                    restoreButton();
                }
            });
        })();
    </script>
}
