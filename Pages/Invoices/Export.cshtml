@page
@model Verifactu.Portal.Pages.Invoices.ExportModel
@{
    ViewData["Title"] = "Exportar facturas";
}

<h1 class="mb-4">Exportar facturas en XML</h1>
<p class="text-muted">Descarga todas las facturas del periodo indicado en un archivo comprimido con su representación XML.</p>

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<form method="post" class="row g-3 mb-4" id="invoice-export-form">
    <div class="col-sm-4 col-md-3">
        <label asp-for="FechaDesde" class="form-label"></label>
        <input asp-for="FechaDesde" type="date" class="form-control" />
        <span asp-validation-for="FechaDesde" class="text-danger"></span>
    </div>
    <div class="col-sm-4 col-md-3">
        <label asp-for="FechaHasta" class="form-label"></label>
        <input asp-for="FechaHasta" type="date" class="form-control" />
        <span asp-validation-for="FechaHasta" class="text-danger"></span>
    </div>
    <div class="col-12">
        <label class="form-label mb-2">Documentos incluidos</label>
        <div class="d-flex flex-wrap gap-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="PreFirma" id="docs-prefirma" name="Docs" checked />
                <label class="form-check-label" for="docs-prefirma">PreFirma</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="PostFirma" id="docs-postfirma" name="Docs" checked />
                <label class="form-check-label" for="docs-postfirma">PostFirma</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Aeat" id="docs-aeat" name="Docs" />
                <label class="form-check-label" for="docs-aeat">Aeat</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Qr" id="docs-qr" name="Docs" />
                <label class="form-check-label" for="docs-qr">Qr</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="all" id="docs-all" />
                <label class="form-check-label" for="docs-all">Todos</label>
            </div>
        </div>
        <div class="form-text">Por defecto: PreFirma + PostFirma.</div>
    </div>
    <div class="col-12">
        <div id="export-status" class="alert alert-info d-none" role="status"></div>
        <button type="submit" class="btn btn-primary" id="export-submit">
            <span id="export-spinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span id="export-button-text">Nueva exportación</span>
        </button>
        <a asp-page="./Index" class="btn btn-outline-secondary">Volver</a>
    </div>
</form>

<h2 class="h4 mb-3">Exportaciones</h2>
<div class="table-responsive">
    <table class="table table-sm align-middle" id="export-jobs-table">
        <thead>
            <tr>
                <th scope="col">Creada</th>
                <th scope="col">Actualizada</th>
                <th scope="col">Estado</th>
                <th scope="col">Rango</th>
                <th scope="col">Docs</th>
                <th scope="col">Archivo</th>
                <th scope="col">Error</th>
                <th scope="col" class="text-end">Acciones</th>
            </tr>
        </thead>
        <tbody id="export-jobs-body">
            <tr>
                <td colspan="8" class="text-muted">Cargando exportaciones…</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="d-flex justify-content-between align-items-center">
    <button type="button" class="btn btn-outline-secondary btn-sm" id="export-refresh">
        Recargar exportaciones
    </button>
    <button type="button" class="btn btn-outline-primary btn-sm d-none" id="export-load-more">
        Cargar más
    </button>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const form = document.getElementById('invoice-export-form');
            const submitButton = document.getElementById('export-submit');
            const spinner = document.getElementById('export-spinner');
            const buttonText = document.getElementById('export-button-text');
            const statusAlert = document.getElementById('export-status');
            const jobsBody = document.getElementById('export-jobs-body');
            const loadMoreButton = document.getElementById('export-load-more');
            const refreshButton = document.getElementById('export-refresh');
            const defaultButtonText = buttonText ? buttonText.textContent : 'Generar exportación';

            const pageSize = 50;
            let continuationToken = null;
            let includeDeleted = false;
            let isLoadingList = false;
            let jobs = [];
            const refreshIntervalMs = 15000;
            let refreshIntervalId = null;

            if (!form || !submitButton || !spinner || !buttonText || !statusAlert || !jobsBody || !loadMoreButton || !refreshButton) {
                return;
            }

            const antiForgeryInput = form.querySelector('input[name="__RequestVerificationToken"]');
            const antiForgeryToken = antiForgeryInput ? antiForgeryInput.value : null;

            const resetStatus = () => {
                statusAlert.textContent = '';
                statusAlert.classList.add('d-none');
                statusAlert.classList.remove('alert-danger', 'alert-success', 'alert-warning');
                if (!statusAlert.classList.contains('alert-info')) {
                    statusAlert.classList.add('alert-info');
                }
            };

            const showStatus = (message, type) => {
                if (!message) {
                    resetStatus();
                    return;
                }

                statusAlert.textContent = message;
                statusAlert.classList.remove('d-none', 'alert-info', 'alert-danger', 'alert-success', 'alert-warning');
                statusAlert.classList.add(`alert-${type}`);
            };

            const setLoadingState = () => {
                submitButton.disabled = true;
                spinner.classList.remove('d-none');
                buttonText.textContent = 'Creando exportación...';
                showStatus('Creando job de exportación…', 'info');
            };

            const restoreButton = () => {
                submitButton.disabled = false;
                spinner.classList.add('d-none');
                buttonText.textContent = defaultButtonText;
            };

            const updateRefreshButtonState = () => {
                if (refreshButton) {
                    refreshButton.disabled = isLoadingList;
                }
            };

            const formatDateTime = (iso) => {
                if (!iso) {
                    return '-';
                }

                const date = new Date(iso);
                if (Number.isNaN(date.getTime())) {
                    return '-';
                }

                return date.toLocaleString();
            };

            const statusBadgeClass = (status) => {
                const value = (status || '').toString().toUpperCase();
                switch (value) {
                    case 'COMPLETED': return 'bg-success';
                    case 'FAILED': return 'bg-danger';
                    case 'DELETED': return 'bg-secondary';
                    case 'RUNNING': return 'bg-info';
                    case 'PENDING': return 'bg-warning text-dark';
                    default: return 'bg-secondary';
                }
            };

            const shouldPoll = () => {
                return jobs.some(job => {
                    const status = (job.status || '').toString().toUpperCase();
                    return status === 'PENDING' || status === 'RUNNING';
                });
            };

            const stopPolling = () => {
                if (refreshIntervalId !== null) {
                    window.clearInterval(refreshIntervalId);
                    refreshIntervalId = null;
                }
            };

            const startPolling = () => {
                if (refreshIntervalId !== null) {
                    return;
                }

                refreshIntervalId = window.setInterval(() => {
                    if (!isLoadingList) {
                        loadJobsPage(true);
                    }
                }, refreshIntervalMs);
            };

            const updatePollingState = () => {
                if (shouldPoll()) {
                    startPolling();
                } else {
                    stopPolling();
                }
            };

            const renderJobs = () => {
                jobsBody.innerHTML = '';

                if (!jobs || jobs.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="8" class="text-muted">No hay exportaciones todavía.</td>';
                    jobsBody.appendChild(row);
                    return;
                }

                jobs
                    .slice()
                    .sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''))
                    .forEach(job => {
                        const status = (job.status || '').toString().toUpperCase() || 'PENDING';
                        const isCompleted = status === 'COMPLETED';

                        const row = document.createElement('tr');
                        const range = `${job.from || '—'} → ${job.to || '—'}`;
                        const docs = job.docs || '-';
                        const fileName = job.fileName || '-';
                        const errorText = (job.error || (status === 'FAILED' ? job.message : null)) || '';

                        const canDownload = isCompleted;
                        const downloadDisabled = canDownload ? '' : 'disabled';

                        row.innerHTML = `
                            <td>${formatDateTime(job.createdAt)}</td>
                            <td>${formatDateTime(job.updatedAt)}</td>
                            <td><span class="badge ${statusBadgeClass(status)}">${status}</span></td>
                            <td>${range}</td>
                            <td>${docs}</td>
                            <td>${fileName}</td>
                            <td class="small text-muted">${errorText}</td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-success me-2" data-action="download" data-job-id="${job.jobId}" ${downloadDisabled}>Descargar ZIP</button>
                                <button type="button" class="btn btn-sm btn-outline-danger me-2" data-action="delete" data-job-id="${job.jobId}" ${downloadDisabled}>Eliminar</button>
                            </td>
                        `;

                        jobsBody.appendChild(row);
                    });

                updatePollingState();
            };

            const buildDocsParam = (formData) => {
                const allCheckbox = document.getElementById('docs-all');
                if (allCheckbox && allCheckbox.checked) {
                    return 'all';
                }

                const docs = formData.getAll('Docs')
                    .map(v => (v ?? '').toString().trim())
                    .filter(v => v.length > 0);

                if (docs.length === 0) {
                    return '';
                }

                return docs.join('|');
            };

            const docsAllCheckbox = document.getElementById('docs-all');
            const docsOptionCheckboxes = Array.from(document.querySelectorAll('input[name="Docs"]'));
            if (docsAllCheckbox && docsOptionCheckboxes.length > 0) {
                docsAllCheckbox.addEventListener('change', function () {
                    if (docsAllCheckbox.checked) {
                        docsOptionCheckboxes.forEach(cb => cb.checked = true);
                    }
                });

                docsOptionCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function () {
                        if (!cb.checked) {
                            docsAllCheckbox.checked = false;
                        }
                    });
                });
            }

            resetStatus();
            renderJobs();

            const triggerUrlDownload = (url) => {
                const link = document.createElement('a');
                link.href = url;
                link.rel = 'noopener';
                link.target = '_blank';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const loadJobsPage = async (reset) => {
                if (isLoadingList) {
                    return;
                }

                isLoadingList = true;
                loadMoreButton.disabled = true;
                updateRefreshButtonState();

                if (reset) {
                    continuationToken = null;
                    jobs = [];
                    renderJobs();
                }

                try {
                    let url = `?handler=List&pageSize=${encodeURIComponent(pageSize)}`;
                    if (continuationToken) {
                        url += `&continuationToken=${encodeURIComponent(continuationToken)}`;
                    }
                    if (includeDeleted) {
                        url += '&includeDeleted=true';
                    }

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        let message = `No se pudo cargar el listado (${response.status}).`;
                        const contentType = response.headers.get('Content-Type') ?? '';
                        try {
                            if (contentType.includes('application/json')) {
                                const data = await response.json();
                                if (data && typeof data.message === 'string' && data.message.trim().length > 0) {
                                    message = data.message.trim();
                                }
                            } else {
                                const text = (await response.text()).trim();
                                if (text.length > 0 && text.length < 500) {
                                    message = text;
                                }
                            }
                        } catch {
                            // ignore
                        }

                        showStatus(message, 'danger');
                        return;
                    }

                    const data = await response.json();
                    const items = Array.isArray(data.items) ? data.items : [];
                    continuationToken = data.continuationToken || null;
                    jobs = jobs.concat(items);
                    renderJobs();
                    loadMoreButton.classList.toggle('d-none', !continuationToken);
                } catch (error) {
                    console.error('Error cargando listado de exportaciones.', error);
                    showStatus('No se pudo cargar el listado de exportaciones.', 'danger');
                } finally {
                    isLoadingList = false;
                    loadMoreButton.disabled = false;
                    updateRefreshButtonState();
                }
            };

            const downloadJob = async (jobId) => {
                const job = jobs.find(j => j.jobId === jobId);
                if (!job) {
                    showStatus('No se encontró la exportación.', 'warning');
                    return;
                }

                try {
                    const response = await fetch(`?handler=Status&jobId=${encodeURIComponent(jobId)}`, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        let message = `No se pudo consultar el estado (${response.status}).`;
                        const contentType = response.headers.get('Content-Type') ?? '';
                        try {
                            if (contentType.includes('application/json')) {
                                const data = await response.json();
                                if (data && typeof data.message === 'string' && data.message.trim().length > 0) {
                                    message = data.message.trim();
                                }
                            } else {
                                const text = (await response.text()).trim();
                                if (text.length > 0 && text.length < 500) {
                                    message = text;
                                }
                            }
                        } catch {
                            // ignore
                        }

                        showStatus(message, 'danger');
                        return;
                    }

                    const data = await response.json();
                    const status = (data.status || '').toString().toUpperCase();
                    const downloadUrl = data.downloadUrl || null;
                    if (status !== 'COMPLETED' || !downloadUrl) {
                        showStatus('La exportación aún no está lista para descargar.', 'warning');
                        return;
                    }

                    triggerUrlDownload(downloadUrl);
                    showStatus('Descarga iniciada.', 'success');
                } catch (error) {
                    console.error('Error descargando exportación.', error);
                    showStatus('No se pudo iniciar la descarga.', 'danger');
                }
            };

            const deleteJob = async (jobId) => {
                try {
                    const formData = new FormData();
                    formData.set('jobId', jobId);
                    if (antiForgeryToken) {
                        formData.set('__RequestVerificationToken', antiForgeryToken);
                    }

                    const response = await fetch('?handler=Delete', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        let message = `No se pudo eliminar la exportación (${response.status}).`;
                        const contentType = response.headers.get('Content-Type') ?? '';
                        try {
                            if (contentType.includes('application/json')) {
                                const data = await response.json();
                                if (data && typeof data.message === 'string' && data.message.trim().length > 0) {
                                    message = data.message.trim();
                                }
                            } else {
                                const text = (await response.text()).trim();
                                if (text.length > 0 && text.length < 500) {
                                    message = text;
                                }
                            }
                        } catch {
                            // ignore
                        }

                        showStatus(message, 'danger');
                        return;
                    }

                    jobs = jobs.filter(j => j.jobId !== jobId);
                    renderJobs();
                    showStatus('Exportación eliminada.', 'success');
                } catch (error) {
                    console.error('Error eliminando exportación.', error);
                    showStatus('No se pudo eliminar la exportación.', 'danger');
                }
            };

            jobsBody.addEventListener('click', function (event) {
                const button = event.target && event.target.closest ? event.target.closest('button[data-action]') : null;
                if (!button) {
                    return;
                }

                const action = button.getAttribute('data-action');
                const jobId = button.getAttribute('data-job-id');
                if (!jobId) {
                    return;
                }

                if (action === 'download') {
                    downloadJob(jobId);
                }

                if (action === 'delete') {
                    deleteJob(jobId);
                }
            });

            loadMoreButton.addEventListener('click', function () {
                loadJobsPage(false);
            });

            refreshButton.addEventListener('click', function () {
                loadJobsPage(true);
            });

            loadJobsPage(true);

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                resetStatus();
                setLoadingState();

                try {
                    const formData = new FormData(form);
                    const docsParam = buildDocsParam(formData);
                    if (docsParam) {
                        formData.set('DocsCsv', docsParam);
                    }
                    const response = await fetch('?handler=Start', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        let message = 'No se pudo generar la exportación. Inténtalo de nuevo más tarde.';
                        const contentType = response.headers.get('Content-Type') ?? '';

                        try {
                            if (contentType.includes('application/json')) {
                                const data = await response.json();
                                if (data && typeof data.message === 'string') {
                                    const trimmed = data.message.trim();
                                    if (trimmed.length > 0) {
                                        message = trimmed;
                                    }
                                }
                            }
                            else {
                                const text = (await response.text()).trim();
                                if (text.length > 0 && text.length < 500) {
                                    message = text;
                                }
                            }
                        } catch (parseError) {
                            console.error('No se pudo interpretar la respuesta de error de la exportación.', parseError);
                        }

                        showStatus(message, 'danger');
                        restoreButton();
                        return;
                    }

                    const data = await response.json();
                    const jobId = data.jobId || null;
                    if (!jobId) {
                        showStatus('No se pudo crear el job de exportación.', 'danger');
                        restoreButton();
                        return;
                    }

                    showStatus('Exportación creada. Actualizando listado…', 'info');
                    await loadJobsPage(true);
                    restoreButton();
                } catch (error) {
                    console.error('Error inesperado al generar la exportación de facturas.', error);
                    showStatus('No se pudo generar la exportación. Inténtalo de nuevo más tarde.', 'danger');
                    restoreButton();
                }
            });
        })();
    </script>
}
